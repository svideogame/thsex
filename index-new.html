<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Video Player with Video.js</title>

    <link href="https://vjs.zencdn.net/8.6.0/video-js.css" rel="stylesheet" />

    <style>
        /* ------------------------------------------- */
        /* ğŸ¯ å¢å¼ºçš„ä¸»é¡µèƒŒæ™¯æ ·å¼ */
        /* ------------------------------------------- */
        /* 1. å…¨å±€æ ·å¼ */
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            /* ç§»é™¤åŸæœ‰çš„ #111 èƒŒæ™¯è‰² */
            background-color: transparent; 
            padding: 20px 0;
            color: white;
            /* å¿…é¡»è®¾ç½®ç›¸å¯¹å®šä½ä»¥å®¹çº³ç»å¯¹å®šä½çš„èƒŒæ™¯å±‚ */
            position: relative; 
        }

        /* 2. åˆ›å»ºä¸€ä¸ªå…¨å±èƒŒæ™¯å±‚ */
        body::before {
            content: "";
            position: fixed; /* å›ºå®šä½ç½®ï¼Œä¸éšæ»šåŠ¨æ¡æ»šåŠ¨ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* æ”¾åœ¨æ‰€æœ‰å†…å®¹çš„åé¢ */
            
            /* ğŸ¯ æ›¿æ¢æˆæ‚¨çš„èƒŒæ™¯å›¾ç‰‡è·¯å¾„ */
            background-image: url('video/global_homepage_background.jpg'); 
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            
            /* ğŸ¯ æ·»åŠ æš—åŒ–å’Œè½»å¾®æ¨¡ç³Šï¼Œå¢å¼ºæ²‰æµ¸æ„Ÿ */
            filter: brightness(0.7) blur(5px);
            transition: filter 0.5s ease;
        }

        /* ------------------------------------------- */
        /* æ’­æ”¾å™¨å’Œç”»å»Šçš„å¸ƒå±€å’Œç¾åŒ– - ä¿æŒä¸å˜æˆ–ä¼˜åŒ– */
        /* ------------------------------------------- */
        .player-container {
            width: 800px;
            max-width: 95%;
            /* å¢åŠ  z-index ç¡®ä¿å®ƒä½äº body::before èƒŒæ™¯å±‚ä¹‹ä¸Š */
            z-index: 10; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); /* å¢å¼ºé˜´å½±æ•ˆæœ */
            background-color: rgba(0, 0, 0, 0.8); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            border-radius: 10px; /* è½»å¾®åœ†è§’ */
            overflow: hidden; /* ç¡®ä¿å†…å®¹ä¸æº¢å‡º */
        }

        /* Video and Overlay Container */
        #video-wrapper {
            position: relative;
            background-color: black;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            overflow: hidden;

            /* âš ï¸ ç§»é™¤æ­¤å¤„çš„å°é¢å›¾ç‰‡å’Œæ¨¡ç³Šï¼Œè®©å…¨å±èƒŒæ™¯ç”Ÿæ•ˆ */
            background-image: none; 
            background-size: initial;
            background-repeat: initial;
            background-position: initial;
        }
        /* âš ï¸ ç§»é™¤åŸæœ‰çš„ #video-wrapper::before ä¼ªå…ƒç´ ï¼Œä½¿ç”¨ body::before ç»Ÿä¸€æ§åˆ¶èƒŒæ™¯ */
        #video-wrapper::before {
            content: none; 
        }

        /* Video and Overlay Positioning - ä¿æŒä¸å˜ */
        #my-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 2;
        }

        /* ------------------------------------------- */
        /* Seductive Overlay - ä¿æŒä¸å˜ */
        /* ------------------------------------------- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: none;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            flex-direction: column;
            z-index: 10;
            cursor: pointer;
        }
        .overlay-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-bottom: 50px;
            z-index: 11;
        }
        .overlay h2 {
            color: #ffcc00;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            text-shadow: 0 0 15px rgba(255, 0, 0, 1);
            margin-bottom: 20px;
            font-weight: 900;
            text-align: center;
            z-index: 11;
            opacity:0.1;
        }
        #start-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            text-transform: uppercase;
            z-index: 11;
            opacity: 0.8;
        }
        #start-btn:hover:not(:disabled) {
            background-color: #cc0000;
            transform: scale(1.05);
            opacity: 1;
        }
        #start-btn:active:not(:disabled) {
            transform: scale(1.02);
            opacity: 0.95;
        }
        #start-btn:disabled {
            background-color: #555;
            cursor: default;
            box-shadow: none;
            opacity: 1;
        }

        /* ------------------------------------------- */
        /* âœ… Video.js Download Button Custom Style - ä¿æŒä¸å˜ */
        /* ------------------------------------------- */
        .vjs-download-button {
            /* æ›¿æ¢ video.js é»˜è®¤æ ·å¼ */
            background: none !important; 
            border: none !important;
            
            /* åº”ç”¨æ‚¨çš„è‡ªå®šä¹‰æ ·å¼ */
            font-size: 1rem !important;
            padding: 5px 10px !important;
            margin-left: 15px !important;
            color: #28a745 !important;
            border: 2px solid #28a745 !important;
            border-radius: 4px !important;
            background-color: #444 !important;
            transition: all 0.2s !important;
            
            /* ç¡®ä¿æ–‡æœ¬å±…ä¸­å¯¹é½ */
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer;
        }
        .vjs-download-button:hover {
            background-color: #28a745 !important;
            color: white !important;
        }

        /* ------------------------------------------- */
        /* Modal for Password Verification - ä¿æŒä¸å˜ */
        /* ------------------------------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #222;
            padding: 30px;
            border: 1px solid #555;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            color: white;
        }
        #modal-password-input {
            width: 90%;
            padding: 10px;
            margin: 10px 0 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
            color: white;
            font-size: 1rem;
        }
        #modal-verify-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        #modal-verify-btn:hover {
            background-color: #0056b3;
        }
        #modal-message {
            margin-top: 15px;
            color: #ff0000;
            font-weight: bold;
        }

        /* ------------------------------------------- */
        /* Video Gallery CSS - ä¿æŒä¸å˜ */
        /* ------------------------------------------- */
        #video-gallery {
            width: 800px;
            max-width: 95%;
            margin-top: 30px;
            text-align: center;
            z-index: 10; /* ç¡®ä¿å®ƒä¹Ÿåœ¨èƒŒæ™¯å›¾ä¹‹ä¸Š */
        }
        #thumbnail-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
        }
        .thumbnail-item {
            width: 160px;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.2s, opacity 0.2s;
            opacity: 0.7;
        }
        .thumbnail-item:hover {
            opacity: 1;
            border-color: #ff0000;
        }
        .thumbnail-item.active {
            opacity: 1;
            border-color: #ffcc00;
        }
        .thumbnail-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .thumbnail-item p {
            font-size: 0.9rem;
            margin: 5px 0 0;
            color: #ccc;
        }
    </style>
</head>
<body>

    <div class="player-container">
        <div id="video-wrapper">
            <video id="my-video" class="video-js vjs-default-skin" preload="auto" playsinline></video>

            <div id="play-overlay" class="overlay">
                <div class="overlay-content">
                    <h2>ğŸ”¥ Exclusive Content: Click to Unlock ğŸ”¥</h2>

                    <div id="loading-progress-container" style="display: none;">
                        <div id="loading-progress-fill"></div>
                    </div>
                    <p id="loading-progress-text"></p>
                    <button id="start-btn">â–¶ Start Playback</button>
                </div>
            </div>
        </div>
    </div>

    <div id="download-modal" class="modal">
        <div class="modal-content">
            <h3>Download Access Required</h3>
            <p>
                Enter your unique access key to download the video file.
                <br>
                <a href="https://yourdomain.com/get-access-key" target="_blank" style="color: #ffcc00; text-decoration: none; font-weight: bold;">[Click here to get a key]</a>
            </p>
            <input type="password" id="modal-password-input" placeholder="Enter Access Key">
            <button id="modal-verify-btn">Submit Key</button>
            <p id="modal-message"></p>
        </div>
    </div>

    <div id="video-gallery">
        <h3>More Content</h3>
        <div id="thumbnail-list">
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.6.0/video.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/5.15.0/videojs-contrib-hls.js"></script>

    <script>
        // ----------------------------------------------------
        // Configuration - ä¿æŒä¸å˜
        // ----------------------------------------------------
        const PASSBOOK_FILE_PATH = "data/passbook.txt"; 
        const PASSBOOK_HEADER_LENGTH = 1000;

        const videoList = [
            {
                title: "Jordan Carver - The Locker (MP4)",
                path: 'video/Jordan Carver - The Locker.mp4', 
                type: 'video/mp4', 
                thumbnail: 'video/thumb_default.jpg'
            },
            {
                title: "Video #2: Sneak Peak (HLS)",
                path: 'video/video2/master.m3u8',
                type: 'application/x-mpegURL',
                thumbnail: 'video/thumb2.jpg'
            },
            {
                title: "Video #3: Best Moments (MP4)",
                path: 'video/best_moments.mp4', 
                type: 'video/mp4',
                thumbnail: 'video/thumb3.jpg'
            }
        ];

        let currentVideoIndex = 0;
        let player = null; 
        let cachedPassbook = null;
        let isDownloadReady = false; 

        // DOM Element Retrieval
        const videoWrapper = document.getElementById('video-wrapper');
        const playOverlay = document.getElementById('play-overlay');
        const startButton = document.getElementById('start-btn');
        const thumbnailListDiv = document.getElementById('thumbnail-list');
        const downloadModal = document.getElementById('download-modal');
        const modalPasswordInput = document.getElementById('modal-password-input');
        const modalVerifyBtn = document.getElementById('modal-verify-btn');
        const modalMessage = document.getElementById('modal-message');

        // ----------------------------------------------------
        // 1. Video.js é›†æˆå’Œæ§åˆ¶é€»è¾‘ - ä¿æŒä¸å˜
        // ----------------------------------------------------

        function handleStartPlayback() {
            const videoData = videoList[currentVideoIndex];

            // 1. éšè—è¦†ç›–å±‚
            playOverlay.style.display = 'none';
            videoWrapper.style.backgroundImage = 'none';
            
            // 2. å‘Šè¯‰ Video.js åŠ è½½æ ‡å‡†æº
            player.src({
                src: videoData.path, 
                type: videoData.type 
            });

            // 3. å¯ç”¨ Video.js æ§ä»¶ï¼Œå¹¶å°è¯•æ’­æ”¾
            player.controls(true);
            player.play().catch(e => {
                console.warn("Autoplay prevented:", e);
                player.controls(true); 
            });

            // 4. è®¾ç½®ä¸‹è½½çŠ¶æ€
            isDownloadReady = (videoData.type === 'video/mp4'); 

            // 5. æ˜¾ç¤º Video.js é»˜è®¤çš„åŠ è½½åŠ¨ç”»
            player.loadingSpinner.show();
        }

        function loadVideoForDisplay(index) {
            currentVideoIndex = index;
            const videoData = videoList[index];
            
            // 1. é‡ç½®å¹¶æ˜¾ç¤ºæ’­æ”¾è¦†ç›–å±‚
            document.querySelector('.overlay h2').textContent = `ğŸ”¥ Exclusive Content: ${videoData.title} ğŸ”¥`;
            startButton.textContent = `â–¶ Start Playback`;
            startButton.disabled = false;
            playOverlay.style.cursor = 'pointer';
            playOverlay.style.display = 'flex';
            
            // 2. é‡ç½® Video.js æ’­æ”¾å™¨
            if (player) {
                player.reset();
                player.controls(false);
                player.loadingSpinner.hide();
            }
            
            // 3. æ›´æ–°ç¼©ç•¥å›¾æ´»åŠ¨çŠ¶æ€
            updateActiveThumbnail(index);
        }

        /**
         * å°†è‡ªå®šä¹‰ä¸‹è½½æŒ‰é’®æ·»åŠ åˆ° Video.js æ§ä»¶æ ã€‚
         */
        function setupVideoJSControls() {
            const Button = videojs.getComponent('Button');
            
            const DownloadButton = videojs.extend(Button, { 
                constructor: function() { 
                    Button.apply(this, arguments); 

                    this.el().innerHTML = 'Download â¬‡'; 
                    this.addClass('vjs-download-button'); 
                },
                handleClick: function() {
                    showDownloadModal();
                }
            });

            videojs.registerComponent('DownloadButton', DownloadButton);
            // å°†æŒ‰é’®æ·»åŠ åˆ°æ§åˆ¶æ çš„æœ«å°¾
            player.controlBar.addChild('DownloadButton', {}, player.controlBar.children().length); 
        }

        // ----------------------------------------------------
        // 2. Gallery & Utility Functions - ä¿æŒä¸å˜
        // ----------------------------------------------------

        function renderVideoGallery() {
            thumbnailListDiv.innerHTML = ''; 
            videoList.forEach((video, index) => {
                const item = document.createElement('div');
                item.className = 'thumbnail-item';
                item.setAttribute('data-index', index);
                const img = document.createElement('img');
                img.src = video.thumbnail;
                img.alt = video.title;
                const title = document.createElement('p');
                title.textContent = video.title;
                item.appendChild(img);
                item.appendChild(title);
                
                item.addEventListener('click', () => {
                    loadVideoForDisplay(index);
                });
                thumbnailListDiv.appendChild(item);
            });
        }

        function updateActiveThumbnail(activeIndex) {
            document.querySelectorAll('.thumbnail-item').forEach((item, index) => {
                item.classList.remove('active');
                if (index === activeIndex) {
                    item.classList.add('active');
                }
            });
        }

        /* * --- 3. SHA-256 Utility and Passbook Loading --- - ä¿æŒä¸å˜ */
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function loadPassbook() {
            if (cachedPassbook) { return cachedPassbook; }
            try {
                const response = await fetch(PASSBOOK_FILE_PATH);
                if (!response.ok) { throw new Error(`Failed to load passbook: HTTP ${response.status}`); }
                const passbookText = await response.text();
                let cleanPassbook = passbookText.trim().toLowerCase();
                if (cleanPassbook.length > PASSBOOK_HEADER_LENGTH) {
                    cleanPassbook = cleanPassbook.slice(PASSBOOK_HEADER_LENGTH);
                }
                cachedPassbook = cleanPassbook;
                return cachedPassbook;
            } catch (error) {
                console.error("[ERROR] Passbook loading failed:", error);
                modalMessage.textContent = "Verification system error.";
                throw error;
            }
        }

        /* * --- 4. Download & Verification Logic --- - ä¿æŒä¸å˜ */

        function showDownloadModal() {
            if (!isDownloadReady) {
                 alert("Error: Only MP4 sources are eligible for direct download.");
                 return;
            }
            modalPasswordInput.value = '';
            modalMessage.textContent = '';
            downloadModal.style.display = 'flex';
        }

        function triggerFrontendDownload() {
            const videoData = videoList[currentVideoIndex];
            
            if (videoData.type !== 'video/mp4' || !isDownloadReady) {
                 alert("Download failed: Content not a downloadable format.");
                 return;
            }
            
            // ä½¿ç”¨ MP4 æ–‡ä»¶çš„ç›´æ¥è·¯å¾„è¿›è¡Œä¸‹è½½
            const downloadURL = videoData.path; 
            const a = document.createElement('a');
            a.href = downloadURL;
            const videoTitle = videoData.title.replace(/[^a-z0-9]/gi, '_');
            a.download = `${videoTitle}.mp4`; 

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function handleModalVerification() {
            const inputToken = modalPasswordInput.value.trim();
            if (!inputToken) { modalMessage.textContent = "Please enter your access key."; return; }

            if (!isDownloadReady) {
                 modalMessage.textContent = "Download data not ready. Please wait.";
                 return;
            }

            modalMessage.textContent = "Verifying...";
            modalVerifyBtn.disabled = true;

            try {
                const inputHash = await sha256(inputToken);
                const passbook = await loadPassbook();
                if (!passbook) { return; }

                const accessGranted = passbook.includes(inputHash);

                if (accessGranted) {
                    modalMessage.textContent = "Success! Starting download...";

                    setTimeout(() => {
                        downloadModal.style.display = 'none';
                        modalPasswordInput.value = '';
                        modalMessage.textContent = '';
                        triggerFrontendDownload(); 
                    }, 500);

                } else {
                    modalMessage.textContent = "Invalid key. Access denied.";
                }
            } catch (error) {
                modalMessage.textContent = "Verification error (check console).";
            } finally {
                modalVerifyBtn.disabled = false;
            }
        }


        // ----------------------------------------------------
        // 5. Initialization - ä¿æŒä¸å˜
        // ----------------------------------------------------

        function init() {
            // 1. åˆå§‹åŒ– Video.js å®ä¾‹
            player = videojs('my-video', {
                controls: false, 
                autoplay: false,
                techOrder: ['html5'], 
                loop: false,
                fluid: true, 
                playbackRates: [0.5, 1, 1.5, 2] 
            });
            
            // 2. ç­‰å¾…æ’­æ”¾å™¨å‡†å¤‡å¥½åå†è®¾ç½®æ§ä»¶
            player.ready(() => {
                setupVideoJSControls();
            });

            // 3. æ¸²æŸ“ç”»å»Š
            renderVideoGallery(); 
            
            // 4. æ³¨å†Œå¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startButton.addEventListener('click', handleStartPlayback);
            
            // 5. åˆå§‹åŒ– Galleryï¼Œé»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘çš„æ•°æ®
            loadVideoForDisplay(currentVideoIndex);

            // 6. Modal äº‹ä»¶
            downloadModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            modalVerifyBtn.addEventListener('click', handleModalVerification);
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>